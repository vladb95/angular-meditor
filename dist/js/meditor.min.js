angular.module("angular-meditor",["colorpicker.module","ngPopover"]).directive("meditor",["$timeout",function(e){return{scope:{ngModel:"=",toolbarContainer:"@?"},require:"?ngModel",transclude:!0,template:'<div class="angular-meditor"><div class="angular-meditor-toolbar" style="top: {{ position.top }}px; left: {{ position.left }}px" ng-class="{ \'angular-meditor-toolbar--show\': model.showToolbar, \'angular-meditor-toolbar--bottom\': position.below }"><ul><li><button type="button" ng-click="SimpleAction(\'bold\')" class="meditor-button-bold" ng-class="{ \'bold\': \'meditor-button--active\' }[styles.fontWeight]">B</button></li><li><button type="button" ng-click="SimpleAction(\'italic\')" class="meditor-button-italic" ng-class="{ \'italic\': \'meditor-button--active\' }[styles.fontStyle]">I</button></li><li><button type="button" ng-click="SimpleAction(\'underline\')" class="meditor-button-underline" ng-class="{ \'underline\': \'meditor-button--active\' }[styles.textDecoration]">U</button></li><li><button type="button" ng-click="SimpleAction(\'insertUnorderedList\')" class="meditor-button-list-ul" ng-class="{ \'underline\': \'meditor-button--active\' }[styles.textDecoration]"><i class="fa fa-list-ul"></i></button></li><li><button type="button" ng-click="SimpleAction(\'insertOrderedList\')" class="meditor-button-list-ol" ng-class="{ \'underline\': \'meditor-button--active\' }[styles.textDecoration]"><i class="fa fa-list-ol"></i></button></li><li><button type="button" ng-click="SimpleAction(\'formatBlock\', \'blockquote\')" class="meditor-button-quote" ng-class="{ \'underline\': \'meditor-button--active\' }[styles.textDecoration]"><i class="fa fa-quote-right"></i></button></li><li><button type="button" class="meditor-button-quote" ng-class="{ \'underline\': \'meditor-button--active\' }[styles.textDecoration]" colorpicker ng-change="SimpleAction(\'foreColor\', color)" ng-model="color"><i class="fa fa-font"></i></button></li><li><label class="meditor-select"><select ng-model="size" ng-options="s.value as s.label for s in sizeOptions" class="meditor-size-selector"></select></label></li><li><label class="meditor-select"><select ng-model="family" ng-options="s as s.label for s in familyOptions" class="meditor-family-selector"></select></label></li><li><button type="button" ng-click="SimpleAction(\'link\')" class="meditor-button-link" ng-class="{ \'underline\': \'meditor-button--active\' }[styles.textDecoration]"><i class="fa fa-link"></i></button></li><li><button type="button" ng-click="SimpleAction(\'insertImage\', \'http://cfis.github.io/free-image-ruby/cookbook/lena_rotate_ex_45_masked.png\')" class="meditor-button-link" ng-class="{ \'underline\': \'meditor-button--active\' }[styles.textDecoration]"><i class="fa fa-picture-o"></i></button></li></ul></div><div class="angular-meditor-content" contenteditable meditor-contenteditable ng-model="model.ngModel" ng-transclude></div></div>',link:function(t,o,n,l){t.model={ngModel:t.ngModel,showToolbar:!1},t.color="",t.$watch("model.ngModel",function(){e(function(){t.ngModel=t.model.ngModel})}),t.position={top:10,left:10,below:!1},t.sizeOptions=[{label:"10",value:1},{label:"13",value:2},{label:"16",value:3},{label:"18",value:4},{label:"24",value:5},{label:"32",value:6},{label:"48",value:7}],t.size=t.sizeOptions[0].value,t.familyOptions=[{label:"Open Sans",value:"Open Sans, sans-serif"},{label:"Source Sans Pro",value:"Source Sans Pro, sans-serif"},{label:"Exo",value:"Exo, sans-serif"},{label:"Oswald",value:"Oswald, sans-serif"},{label:"Cardo",value:"Cardo, serif"},{label:"Vollkorn",value:"Vollkorn, serif"},{label:"Old Standard TT",value:"Old Standard TT, serif"}],t.family=t.familyOptions[0],t.styles={};var i={b:"",strong:"",i:"",em:"",u:"",blockquote:""},a=function(e,t){var o=null;return function(){var n=this,l=arguments;clearTimeout(o),o=setTimeout(function(){e.apply(n,l)},t)}},s=angular.element(o[0].querySelector(".angular-meditor-toolbar")),r=angular.element(o[0].querySelector(".angular-meditor-content")),c=angular.element(o[0].querySelector("select")),u=angular.element(document.querySelector(t.toolbarContainer)||document.body),d=function(){var e=s[0].offsetHeight,o=s[0].offsetWidth,n=window.getSelection(),l=n.getRangeAt(0),i=l.getBoundingClientRect(),a=i.top,r=i.left;i.top<e+5?(t.position.top=a+i.height+5,t.position.below=!0):(t.position.top=a-e-5,t.position.below=!1),t.position.left=r-o/2+i.width/2;var c=void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,u=void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;return t.position.top+=u,t.position.left+=c,this},m=function(n){if(n&&n.target&&s.find(n.target).length)return!1;var l=window.getSelection(),i=l.anchorNode;if(""===l.toString().trim()||!i)return e(function(){t.model.showToolbar=!1});for(var a=i.parentNode;void 0!==a.tagName&&a!==o[0];)a=a.parentNode;return a===o[0]?(e(function(){t.model.showToolbar=!0,d()}),b(l)):e(function(){t.model.showToolbar=!1}),this},b=function(o){var n=o.anchorNode;n.tagName||(n=o.anchorNode.parentNode);var l=n.childNodes[0];l&&l.tagName&&l.tagName.toLowerCase()in i&&(n=n.childNodes[0]),e(function(){t.styles=window.getComputedStyle(n,null),t.styles.fontSize!==t.size.label+"px"&&angular.forEach(t.sizeOptions,function(e,o){if(t.styles.fontSize===e.label+"px")return t.size=t.sizeOptions[o].value,!1})})};r.bind("keyup",m),document.addEventListener("mouseup",a(m,200)),r.bind("blur",a(m,200)),c.bind("blur",a(m,200)),t.SimpleAction=function(e,o){o||(o=null),document.execCommand("styleWithCSS",!1,!1),document.execCommand(e,!1,o),t.$broadcast("meditor-change")},t.$watch("size",function(){document.execCommand("styleWithCSS",!1,!1),document.execCommand("fontSize",!1,t.size),t.$broadcast("meditor-change")}),t.$watch("family",function(){window.WebFont&&WebFont.load({google:{families:[t.family.label]}}),document.execCommand("styleWithCSS",!1,!0),document.execCommand("fontName",!1,t.family.value),t.$broadcast("meditor-change")}),function(){var e=document.createElement("script");e.src=("https:"===document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",e.type="text/javascript",e.async="true";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(),u.append(s)}}}]).directive("meditorContenteditable",["$timeout",function(e){"use strict";return{require:"?ngModel",link:function(t,o,n,l){if(void 0!==t.ngModel){var i=function(){e(function(){l.$setViewValue(o.html())})};t.$on("meditor-change",i),o.on("blur keyup",i),l.$render=function(){o.html(l.$viewValue)},l.$setViewValue(t.ngModel),o.html(l.$viewValue),t.$watch("ngModel",function(e){o.html()!==e&&o.html(e)})}}}}]);
"use strict";angular.module("colorpicker.module",[]).factory("Helper",function(){return{closestSlider:function(e){return(e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector).bind(e)("I")?e.parentNode:e},getOffset:function(e){for(var t=0,o=0;e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)t+=e.offsetLeft,o+=e.offsetTop,e=e.offsetParent;return{top:o,left:t}},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[2.55*e[1],2.55*e[2],2.55*e[3],e[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}]}}).factory("Color",["Helper",function(e){return{value:{h:1,s:1,b:1,a:1},rgb:function(){var e=this.toRGB();return"rgb("+e.r+","+e.g+","+e.b+")"},rgba:function(){var e=this.toRGB();return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(e,t,o,n){e/=255,t/=255,o/=255;var r,a,i,s;return i=Math.max(e,t,o),s=i-Math.min(e,t,o),r=0===s?null:i==e?(t-o)/s:i==t?(o-e)/s+2:(e-t)/s+4,r=(r+360)%6*60/360,a=0===s?0:s/i,{h:r||1,s:a,b:i,a:n||1}},HueToRGB:function(e,t,o){return o<0?o+=1:o>1&&(o-=1),6*o<1?e+(t-e)*o*6:2*o<1?t:3*o<2?e+(t-e)*(2/3-o)*6:e},setColor:function(t){t=t.toLowerCase();for(var o in e.stringParsers){var n=e.stringParsers[o],r=n.re.exec(t),a=r&&n.parse(r);n.space;if(a)return this.value=this.RGBtoHSB.apply(null,a),!1}},setHue:function(e){this.value.h=1-e},setSaturation:function(e){this.value.s=e},setLightness:function(e){this.value.b=1-e},setAlpha:function(e){this.value.a=parseInt(100*(1-e),10)/100},toRGB:function(e,t,o,n){e||(e=this.value.h,t=this.value.s,o=this.value.b),e*=360;var r,a,i,s,l;return e=e%360/60,l=o*t,s=l*(1-Math.abs(e%2-1)),r=a=i=o-l,e=~~e,r+=[l,s,0,0,s,l][e],a+=[s,l,l,s,0,0][e],i+=[0,0,s,l,l,s][e],{r:Math.round(255*r),g:Math.round(255*a),b:Math.round(255*i),a:n||this.value.a}},toHex:function(e,t,o,n){var r=this.toRGB(e,t,o,n);return"#"+(1<<24|parseInt(r.r,10)<<16|parseInt(r.g,10)<<8|parseInt(r.b,10)).toString(16).substr(1)}}}]).factory("Slider",["Helper",function(e){var t={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},o={};return{getSlider:function(){return t},getLeftPosition:function(e){return Math.max(0,Math.min(t.maxLeft,t.left+((e.pageX||o.left)-o.left)))},getTopPosition:function(e){return Math.max(0,Math.min(t.maxTop,t.top+((e.pageY||o.top)-o.top)))},setSlider:function(n,r){var a=e.closestSlider(n.target);t.knob=a.children[0].style,t.left=n.pageX-e.getOffset(a).left,t.top=n.pageY-e.getOffset(a).top,r&&(t.left-=window.pageXOffset,t.top-=window.pageYOffset),o={left:n.pageX,top:n.pageY}},setSaturation:function(e,o){t={maxLeft:100,maxTop:100,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(e,o)},setHue:function(e,o){t={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setHue"},this.setSlider(e,o)},setAlpha:function(e,o){t={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setAlpha"},this.setSlider(e,o)},setKnob:function(e,o){t.knob.top=e+"px",t.knob.left=o+"px"}}}]).directive("colorpicker",["$document","$compile","Color","Slider","Helper",function(e,t,o,n,r){return{require:"?ngModel",restrict:"A",link:function(a,i,s,l){var c,u=angular.element('<div class="colorpicker f-dropdown"><colorpicker-saturation><i></i></colorpicker-saturation><colorpicker-hue><i></i></colorpicker-hue><colorpicker-alpha><i></i></colorpicker-alpha><colorpicker-preview></colorpicker-preview><button class="tiny secondary button right">&times;</button></div>'),f=o,p=u.find("colorpicker-hue"),d=u.find("colorpicker-saturation"),h=u.find("colorpicker-preview"),g=u.find("i"),v=s.colorpicker?s.colorpicker:"hex",m=!!angular.isDefined(s.colorpickerFixedPosition)&&s.colorpickerFixedPosition,b=angular.isDefined(s.colorpickerParent)?i.parent():angular.element(document.body);t(u)(a);var k=function(){e.on("mousemove",S),e.on("mouseup",w)};"rgba"===v&&(u.addClass("alpha"),c=u.find("colorpicker-alpha"),c.on("click",function(e){n.setAlpha(e,m),S(e)}).on("mousedown",function(e){n.setAlpha(e,m),k()})),p.on("click",function(e){n.setHue(e,m),S(e)}).on("mousedown",function(e){n.setHue(e,m),k()}),d.on("click",function(e){n.setSaturation(e,m),S(e)}).on("mousedown",function(e){n.setSaturation(e,m),k()}),m&&u.addClass("colorpicker-fixed-position"),b.append(u),l&&(l.$render=function(){i.val(l.$viewValue)},a.$watch(s.ngModel,function(){H()})),i.on("$destroy",function(){u.remove()});var x=function(){try{h.css("backgroundColor",f[v]())}catch(e){h.css("backgroundColor",f.toHex())}d.css("backgroundColor",f.toHex(f.value.h,1,1,1)),"rgba"===v&&(c.css.backgroundColor=f.toHex())},S=function(e){var t=n.getLeftPosition(e),o=n.getTopPosition(e),r=n.getSlider();n.setKnob(o,t),r.callLeft&&f[r.callLeft].call(f,t/100),r.callTop&&f[r.callTop].call(f,o/100),x();var s=f[v]();return i.val(s),l&&a.$apply(l.$setViewValue(s)),!1},w=function(){e.off("mousemove",S),e.off("mouseup",w)},H=function(){f.setColor(i.val()),g.eq(0).css({left:100*f.value.s+"px",top:100-100*f.value.b+"px"}),g.eq(1).css("top",100*(1-f.value.h)+"px"),g.eq(2).css("top",100*(1-f.value.a)+"px"),x()},L=function(){var e,t=r.getOffset(i[0]);return e={top:t.top+i[0].offsetHeight,left:t.left},{top:e.top+"px",left:e.left+"px"}};i.on("click",function(){H(),u.addClass("colorpicker-visible").css(L())}),u.on("mousedown",function(e){e.stopPropagation(),e.preventDefault()});var T=function(){u.hasClass("colorpicker-visible")&&u.removeClass("colorpicker-visible")};u.find("button").on("click",function(){T()}),e.on("mousedown",function(){T()})}}}]);